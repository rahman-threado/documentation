import { Tab, Tabs, Callout, Steps } from 'nextra-theme-docs';
import ROQEnv from '/snippets/setup-new-env.mdx';

# Application Deployment on GCP

## Google Cloud Platform

[Google Cloud Platform](https://cloud.google.com/) (GCP) is a suite of cloud computing services that runs on the same infrastructure that Google uses internally for its end-user products, such as Google Search, YouTube, and Google Drive.

Deploying the generated application with a PostgreSQL database on Google Cloud Platform (GCP) involves multiple steps, including setting up a PostgreSQL database on Cloud SQL and deploying the Next.js app on a service like Google App Engine or Google Cloud Run. 

There are so many ways to deploy application on Google Cloud Platform. In this tutorial we will use **Google App Engine** and **Google Cloud SQL**. Below is a guide on how to do this.

{/**/}

<Callout type="info">
The **Billing** features need to be enabled to use the Google Cloud Platform. Basically you need a valid payment method even for [free trial period](https://cloud.google.com/free/docs/gcp-free-tier#free-trial). Go [here](https://cloud.google.com/billing/docs) for further explanation.
</Callout>

## `gcloud`

The [Google Cloud CLI](https://cloud.google.com/cli) or `gcloud` is a set of tools to create and manage Google Cloud resources. You can use these tools to perform many common platform tasks from the command line or through scripts and other automation.

We will use `gcloud` on Windows OS. For another operating system please download Google Cloud CLI from this [link](https://cloud.google.com/sdk/docs/install).

![Google cloud cli windows](/google-cloud-cli-windows.png)

The installation in Windows is straightforward and in the end of installation it will help us to use an existing or creating a new Google Cloud project. 

For example, if we want to connect the generated application with a Google Cloud project. For this scenario, we can use the `gcloud init` command on the root application:

```shell
PS E:\_workspaces\ROQ\anime-scaled-fig-2d3f-v3> gcloud init
Welcome! This command will take you through the configuration of gcloud.

Settings from your current configuration [default] are:
accessibility:
  screen_reader: 'False'
core:
  account: anna.w@gmail.com
  disable_usage_reporting: 'True'
  project: roq-project

Pick configuration to use:
 [1] Re-initialize this configuration [default] with new settings
 [2] Create a new configuration
Please enter your numeric choice:  1

Your current configuration has been set to: [default]

You can skip diagnostics next time by using the following flag:
  gcloud init --skip-diagnostics

Network diagnostic detects and fixes local network connection issues.
Checking network connection...done.
Reachability Check passed.
Network diagnostic passed (1/1 checks passed).

Choose the account you would like to use to perform operations for this configuration:
 [1] anna.w@gmail.com
 [2] Log in with a new account
Please enter your numeric choice:  1

You are logged in as: [anna.w@gmail.com].

This account has no projects.

Would you like to create one? (Y/n)?  y

Enter a Project ID. Note that a Project ID CANNOT be changed later.
Project IDs must be 6-30 characters (lowercase ASCII, digits, or
hyphens) in length and start with a lowercase letter. anime-figure-store
Waiting for [operations/cp.6165428578280918017] to finish...done.
Your current project has been set to: [anime-figure-store].
```

If we don't have a Google Cloud project or we don't want to use the existing one, the `gcloud` will offer us to create a new Google project.
{/*TODO*/}

## Google Cloud SQL

[Google Cloud SQL](https://console.cloud.google.com/sql/) is Google service that offers a fully-managed database service for MySQL, PostgreSQL, and SQL Server. We will use PostgreSQL because it's the default ROQ's generated application database. 

### PostgreSQL

To set up a PostgreSQL database in Google Cloud SQL, a few steps are necessary.

<Steps>
### Create Instance

Sign-in to [Google Cloud Console](https://console.cloud.google.com) and navigate to **SQL** menu in the left sidebar or directly go [here]((https://console.cloud.google.com/sql/)).


![google cloud sql](/google-app-engine-create.png)

To create PostgreSQL, click **Create instance**, then select the **PostgreSQL** database engine.

![PostgreSQL instance](/google-cloud-sql-postgre.png)

<Callout type="info">
In order to create an instance, you have to enable the Compute Engine API first. Google Cloud SQL Console will provide with the **Enable API** button.
</Callout>

### Settings & Configuration  

The next step is to configure the database instance settings such as username, password, PostgreSQL version, region, etc. 

![PostgreSQL instance configuration](/google-cloud-sql-postgre-config.png)

There are some mandatory settings and configuration that need to be set. For example, the generated application we have is about **Anime Figure Store**. We can set the fields:

- **Instance ID**: `animefigurestore`
- **Password**: We can fill anything or generate the password.
- **Database Version**: The default version is the latest version of PostgreSQL. We will use version 15.

The Cloud SQL edition preset, region, and availability are configurable. Choose as per your needs. Be aware that this settings and configuration will affect the database pricing estimation.

### Create Database

After the database instance is created, we can create a new database with the name `animefiguredb`. Go to the SQL **Databases** menu then add a new database with  clicking the **Create Database** button.

![postgresql create a new database](/google-cloud-sql-postgre-database.png)

### Create Users

Google Cloud SQL provide the default admin user `postgres` without  any password. You need to set a password for this user before you can log in. You can do this either in the Google Cloud console or by using `gcloud` command. The database instance for this example is `animefigurestore`.

```
gcloud sql users set-password postgres \
--instance=animefigurestore \
--password=SECRETP4ST$
```

Another option is create new users. We can do this using the **Users** menu and then clicking **ADD USER ACCOUNT**.

![postgresql users](/google-cloud-sql-postgre-users.png)

### `DATABASE_URL`

After creating, take note of the connection credentials and IP address, as you'll need them to connect to the database.

![](/google-cloud-sql-postgre-uri.png)

From the **Connections** information we can form the PostgreSQL database URL:

</Steps>

{/*TODO*/}

## Google App Engine

Create a new Google App Engine for the container of our generated application.

![google app engine](/google-app-engine-create.png)

{/*TODO*/}

## Deploy Application

{/*TODO*/}