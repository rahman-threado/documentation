import { Callout, Tab, Tabs, Steps } from 'nextra-theme-docs';

# Sync User Data with Database

## Introduction

Synchronizing user data ensures users have a consistent view of their information, preferences, and progress across all platforms. ROQ provides APIs for easy data query and management and a webhook to notify the application when an event happens in the account. We can use this feature to sync the user data with third-party applications.

## Objectives

For this tutorial, we will sync user file data from the ROQ platform to a third-party web application using ROQ's [Webhook](/development-guides/webhooks) feature.
{/*
<Callout type="info">
To handle the webhook an sync automation we will use [Zapier](https://zapier.com/). In more technical terms, Zapier is an event-driven, serverless architecture for connecting APIs. You set up triggers and actions between apps, defining how an event in one app should prompt an action in another.
</Callout>
*/}

## Sync Cases

Let's consider an example of an application generated by ROQ for collecting collectible figurine. In such an application, it is common for users to add and remove collection figures which basically just images. If we connect the application with third-party application then we need a ways to sync the user data.

We will use ROQ's webhook to notify third-party applications of events. For instance, when a user adds a new item to their collection, the webhook can notify the third-party app. 

### ROQ Webhook

For this tutorial, we will only be using the webhook for file updates and creations. If you wish to configure it for user and chat activity, you can do so on the ROQ Console. Any user activity related to files will trigger the system to send a message to the specified webhook.

{/* Add setup webhook on ROQ console*/}

For example, the webhook payload for file updates in JSON:

```json
{
	"name": "ROQ_FILE_UPDATE",
	"id": "6c64b15f-30f4-4340-8269-6e01038cb610",
	"object": "file",
	"data": {
		"current": {
			"id": "6c64b15f-30f4-4340-8269-6e01038cb610",
			"name": "Default_3D_character_Has_black_hairee0c-33b0_1.jpg",
			"status": "ready",
			"createdByUserId": "8d18aea8-65a4-4539-b202-8cf44688fa86",
			"isPublic": true,
			"contentType": "image/jpeg",
			"fileCategoryId": "1ebfb78e-5b26-40b2-95a5-b0e001aab658",
			"createdAt": "2023-09-19T11:31:45.537Z",
			"updatedAt": "2023-09-19T11:31:47.394Z"
		},
		"previous": {
			"id": "6c64b15f-30f4-4340-8269-6e01038cb610",
			"name": "3D_character_Has_black_hair_ca_1.jpg",
			"status": "upload_pending",
			"createdByUserId": "8d18aea8-65a4-4539-b202-8cf44688fa86",
			"isPublic": true,
			"contentType": "image/jpeg",
			"fileCategoryId": "1ebfb78e-5b26-40b2-95a5-b0e001aab658",
			"createdAt": "2023-09-19T11:31:45.537Z",
			"updatedAt": "2023-09-19T11:31:45.537Z",
		}
	},
	"environmentId": "051528ea-fcfc-4c6f-a749-e3d21af37127"
}
```

We then can process the data payload and update the necessart data in the third party database.

### Webhook Server

{/* Explain about the real solution options and why need the webhook server below*/}

```js
import express from 'express'
import sqlite3 from 'sqlite3'
import { fileURLToPath } from 'url'
import { dirname } from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const app = express()
const port = 3000

// Initialize SQLite database
const db = new sqlite3.Database(`${__dirname}/myfigurine.db`)

app.use(express.json())

const handleRoqWebhook = (req, res) => {
	const payload = req.body
	const eventName = payload.name

	if (eventName === 'ROQ_FILE_UPDATE') {
		const fileData = payload.data.current
		const previousFileData = payload.data.previous
		// Update the database
		updateDatabase(fileData, previousFileData)
	}

	console.log('Received ROQ payload:', payload)
	res.status(200).send('OK')
}

const updateDatabase = (currentData, previousData) => {
	const query = `UPDATE your_table SET name = ?, status = ? WHERE id = ?`
	const values = [currentData.name, currentData.status, currentData.id]

	db.run(query, values, function (err) {
		if (err) {
			console.log('Database update failed:', err)
			return
		}
		console.log(`Database updated, row(s) affected: ${this.changes}`)
	})
}

app.post('/roq-webhook', handleRoqWebhook)

app.listen(port, () => {
	console.log(`Server listening at http://localhost:${port}`)
})
```



{/*

Sync files between local database (or app) and files in the ROQ platform

User Collections:

Sync Case: Users might have the ability to manage their collections on multiple devices or platforms (web, mobile, third-party apps).

Database Interaction: Sync user collection data across these platforms to ensure a consistent view and management experience.

Applications:

- ROQ's generated application connect to Zapier via ROQ Webhook. Sync files between ROQ and third party tools.

Webhooks:

Method: Use webhooks to notify third-party applications of events within your SaaS. For instance, when a user adds a new item to their collection, the webhook can notify the third-party app.

Consideration: Webhooks are more real-time than periodic API polling, but they also require third-party apps to have an endpoint to receive the data.

*/}

