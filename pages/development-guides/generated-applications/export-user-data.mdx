import { Callout, Tab, Tabs, Steps } from 'nextra-theme-docs';

# Export User Data From ROQ

The ability to export user data is essential for businesses to adapt to operational needs. Export data provides flexibility and control over data. To export data from the generated application, we need to gather all the user related data by their IDs.

## User Data

In order to collect user data, we can make use of ROQ's API, with the help of the User Management API as well as other APIs, such as the File and Chat API. Additionally, we can also collect user data that is related to the project entities.

For example for the user with ID `c095e436-6904-49d0-8b7e-c0ba916ecdad`. To get the user data we can use the [Users API](/user-management/api).

```ts
const userID = "c095e436-6904-49d0-8b7e-c0ba916ecdad"

const userByID = await roqClient.asSuperAdmin().user({
	id: userID,
	withTenant: true,
	withUserGroups: true,
	withRoles: true
})

console.log(JSON.stringify(userByID))
```
The above code will gave user profile data, tenant, user groups, and user roles:

```json
{
	"user": {
		"id": "c095e436-6904-49d0-8b7e-c0ba916ecdad",
		"reference": "c095e436-6904-49d0-8b7e-c0ba916ecdad",
		"firstName": "Anna",
		"lastName": "W.",
		"active": true,
		"email": "anna.w@gmail.com",
		"phone": null,
		"locale": "en-US",
		"isOptedIn": true,
		"synced": false,
		"tenantId": "a750fb55-2b94-4b94-8c87-ddc4deb941ed",
		"customData": {},
		"timezone": "Asia/Jakarta",
		"avatarUrl": "https://s3.fr-par.scw.cloud/a35df408-ee00-4703-9c81-80b5d44a0208-environment-bucket/Fs-CC4maAAEf5xU.jpg",
		"createdAt": "2023-09-11T13:37:59.076Z",
		"updatedAt": "2023-09-14T09:56:02.470Z",
		"tenant": {
			"id": "a750fb55-2b94-4b94-8c87-ddc4deb941ed",
			"reference": null,
			"isDefault": false,
			"name": "Otaku HQ",
			"createdAt": "2023-09-11T13:37:58.807Z",
			"updatedAt": "2023-09-11T13:37:58.807Z"
		},
		"userGroups": {
			"data": [],
			"totalCount": 0
		},
		"roles": {
			"data": [
				{
					"id": "e5a65365-3f88-4f47-90d7-15e581004a65",
					"reference": null,
					"description": "",
					"isSystemManaged": false,
					"key": "store-owner",
					"name": "Store Owner"
				}
 			],
			"totalCount": 1
		}
	}
}
```

To add additional data such as files, we can use the [Files API](/files/api) to get all user files. 

```ts
const userID = "c095e436-6904-49d0-8b7e-c0ba916ecdad"
const myFiles = await roqClient.asUser(userID).files()

console.log(JSON.stringify(myFiles))
```

The result is all files data for user specific ID:

```json
	"files": {
		"data": [
			{
				"id": "302726f3-621e-4c7a-afa5-76ba92c32b94",
				"createdAt": "2023-09-14T09:56:55.980Z",
				"updatedAt": "2023-09-14T09:56:57.696Z",
				"contentType": "text/plain",
				"createdByUserId": "c095e436-6904-49d0-8b7e-c0ba916ecdad",
				"fileCategoryId": "a26ab5e0-2554-46da-822c-8ac2b77f0bc3",
				"isPublic": true,
				"name": "CPD-3080.txt",
				"status": "ready",
				"url": "https://s3.fr-par.scw.cloud/a35df408-ee00-4703-9c81-80b5d44a0208-environment-bucket/CPD-3080.txt"
			},
			{
				"id": "799c8355-6e76-48c6-b3e3-3412fc00de90",
				"createdAt": "2023-09-14T09:56:00.018Z",
				"updatedAt": "2023-09-14T09:56:02.031Z",
				"contentType": "image/jpeg",
				"createdByUserId": "c095e436-6904-49d0-8b7e-c0ba916ecdad",
				"fileCategoryId": "9591e33d-725b-48b8-a2d3-e5c826bd5b45",
				"isPublic": true,
				"name": "Fs-CC4maAAEf5xU.jpg",
				"status": "ready",
				"url": "https://s3.fr-par.scw.cloud/a35df408-ee00-4703-9c81-80b5d44a0208-environment-bucket/Fs-CC4maAAEf5xU.jpg"
			}
		],
		"totalCount": 2
	}
```

{/*Add Chat*/}

We can merge the user data using JavaScript object spread syntax to add an additional user data:

```ts
const userData = {
	...userByID,
	...myFiles
}
```

### User Project Data

We also should retrieve user data from the generated ROQ application, which is linked to the project entities. 

```ts
const entitiesQuery = `
query projectEntities($limit: Int = 10) {
	projectEntities(limit: $limit) {
	  totalCount
	  data {
		id
		name
	  }
	}
  }  
`

const entitiesList = await roqClient.asSuperAdmin().graphqlRequest(entitiesQuery)
console.log(JSON.stringify(entitiesList))
```

<Callout type="info">
We can run GraphQL query in ROQ using `graphqlRequest()` method. Please read this [documentation](/development-guides/graphql-query).
</Callout>

After identifying the project entities, we can query any user data in the project.

### Create Export API Route

To get user data from project entities, we will add a new endpoint for our export functionality. Depends on which environment the generated application is running, for example for a local development environment with the base URL `localhost` and the export endpoint is `/api/export`, the URL will be:

```shell
http://localhost:3000/api/export
```
To add a new API route, create a file in the `pages/api` directory, lets name it `export.ts` with the content:

```ts
import type { NextApiRequest, NextApiResponse } from 'next';
import { withAuth, getServerSession } from '@roq/nextjs';
import { convertQueryToPrismaUtil, parseQueryParams } from 'server/utils';
import { roqClient } from 'server/roq';

export async function handler(req: NextApiRequest, res: NextApiResponse) {
	const session = getServerSession(req, res);
	const { roqUserId, user } = session;

	if (req.method !== 'GET') {
		return res.status(405).json({ message: `Method ${req.method} not allowed` });
	}

	const userByID = await roqClient.asSuperAdmin().user({
		id: roqUserId,
		withTenant: true,
		withUserGroups: true,
		withRoles: true
	});

	const myFiles = await roqClient.asUser(roqUserId).files();

	const entitiesQuery = `
		query projectEntities($limit: Int = 10) {
			projectEntities(limit: $limit) {
				totalCount
				data {
					id
					name
				}
			}
		}
	`;

	const entitiesList = await roqClient.asUser(roqUserId).graphqlRequest(entitiesQuery);
	const entitiesArray = entitiesList?.data?.projectEntities?.data.map(item => item.name) || [];

	const query = parseQueryParams(req.query);
	const allData = {};

	for (let entity of entitiesArray) {
		if (!prisma[entity]) {
			throw new Error(`Entity "${entity}" does not exist in Prisma client.`);
		}
		allData[entity] = await prisma[entity].withAuthorization({
			roqUserId,
			tenantId: user.tenantId,
			roles: user.roles,
		}).findManyPaginated(convertQueryToPrismaUtil(query, entity));
	}

	const userData = {
		userdata: userByID,
		...myFiles,
		...allData
	};

	return res.status(200).json({ data: userData });
}

export default function helloHandler(req: NextApiRequest, res: NextApiResponse) {
	return withAuth(req, res)(handler);
}
```

The code above will query all user data, user roles, user files and any user data from the project entities.


<Callout type="info">
You can read this documentation about [how to add API endpoint](/development-guides/generated-applications/api-endpoints) in the ROQ's generated application for more information.
</Callout>
